(function(r){console.log("auth.js");var i=["GetVarByContext","Act","Login","Getvar","Getnodeip","SwarmLocal","DhtGetAllKeys","DhtGet","DhtGets","SignPPT","SwarmAddrs"];function u(){var o="127.0.0.1:4800";return window.getParam!=null?(p=window.getParam(),console.log("p=",p),o=p.ips[p.CurNode]):window.location.host!=""&&(o=window.location.host),o="192.168.1.104:4800",r.vue.ips=o,o}r.getLocalApiHandler=()=>{var o=u(),n="ws://"+o+"/ws/",l="http://"+o+"/",t={};return t.client=hprose.Client.create(n,i),t.client.GetVarByContext("","ppt").then(e=>(v(e),t.client.Login(e))).then(e=>(vue.isLogined=!0,console.log("sid=",e.sid),console.log("uid=",e.uid),t.baseUrl=l,t.sid=e.sid,t.leitherid=e.uid,vue.systemdata.localnodeid=e.uid,t))},r.doAll=o=>{console.log("doAll"),console.log("api=",o);var n=e=>{vue.sid=e.sid,vue.baseUrl=e.baseUrl,vue.mynodedata.nodeid=e.leitherid};n(o);function l(e,s){console.log("getappvers",s);var a=vue.appsdata.apps[s];return console.log("app=",a,"api.sid=",e.sid),e.client.Getvar(e.sid,"appversions",a.iD).then(d=>(console.log("appvers=",d),vue.appsdata.apps[s].appvers=d,vue.appsdata.apps=vue.appsdata.apps,d),d=>{alert(d)})}function t(e){return console.log("showapps",e),e.client.Getvar(e.sid,"appinfos").then(s=>{console.log("apps=",s),vue.appsdata.apps=s;var a=[];for(iapp in s)a[iapp]=l(e,iapp);return hprose.Future.all(a)})}t(o).then(()=>{console.log("all=");var e=vue.appsdata.apps;vue.appsdata.apps=[],vue.appsdata.apps=e}),o.client.GetVarByContext("","ip").then(function(e){console.log("ip=",e)}),o.client.GetVarByContext("","mac").then(function(e){console.log("mac=",e)}),o.client.Getvar("","nodepk","","raw").then(function(e){console.log("hostpk=",e),vue.mynodedata.hostpk=e}),o.client.Getvar("","nodeaddrs",nodeid).then(function(e){console.log("ips=",e,e.length),e.length>0&&(vue.mynodedata.ips=e[0],e.length>1&&(vue.mynodedata.gateway=e[1],vue.swarmdata.gateway=e[1]))},e=>{console.log(e)}),o.client.Getvar("","peerid").then(function(e){console.log("peerid=",e),vue.mynodedata.peerid=e}),o.client.Getvar("","nodeid").then(function(e){console.log("nodeid=",e),vue.mynodedata.nodeid=e}),o.client.SwarmLocal("").then(function(e){console.log("SwarmLocal =",e),vue.mynodedata.swarmlocal=e}),o.client.DhtGetAllKeys("").then(e=>{console.log("DhtGetAllKeys keys=",e)}),o.client.DhtGets("","IPFS").then(e=>{console.log("DhtGets IPFS ret=",e)}),o.client.DhtGet("","LAN").then(e=>{console.log("DhtGet LAN keys=",e)}),o.client.DhtGets("").then(e=>{console.log("vue.swarmdata.dhts =",e),vue.swarmdata.dhts=e}),o.client.DhtGets("","WAN").then(e=>{console.log("DhtGets WAN ret=",e)}),o.client.SwarmAddrs(o.sid).then(e=>{console.log("SwarmAddrs keys=",e),vue.swarmdata.addrs=e}),o.client.Getvar(o.sid,"systemvars").then(function(e){console.log("cfg=",e),vue.systemdata.oldVars=e,vue.systemdata.systemvars=e})};var c=getLocalApiHandler();r.apiHandler=c,c.then(doAll,o=>{console.log("e=",o)}),r.getApiHandler=(o,n)=>{console.log("getApiHandler",o),hosturl="ws://"+o+"/ws/";var l={};return l.client=hprose.Client.create(hosturl,i),l.client.GetVarByContext("","ppt",{period:60*24*7,subtype:"mac",ppt:n}).then(l.client.Login).then(t=>(console.log("reply=",t),console.log("sid=",t.sid),console.log("uid=",t.uid),l.baseUrl="http//"+o+"/",l.sid=t.sid,l.leitherid=t.uid,l),t=>{console.log(t)})},r.onswitch=o=>{console.log("global.onswitch",o);var n=vue.swarmdata.addrs[o];console.log("global.onswitch",n);var l=h(n);g(l)};function h(o){for(a in o){var n=o[a];console.log(n);var l,t,e=80,s=n.split("/");console.log(s);for(var a=1;a<s.length;a++)switch(console.log(s[a],s[a+1]),s[a++]){case"ip6":l="["+s[a]+"]";break;case"ip4":t=s[a];break;case"tcp":e=s[a];break}if(console.log("ipv6",l,"port",e,"ipv4",t),l)return l+":"+e;if(t&&t.indexOf("192")==0)return t+":"+e}return""}function g(o){c.then(n=>(console.log("api.Client.SignPPT"),n.client.SignPPT(n.sid,{CertFor:"Self",Userid:n.Userid},1))).then(n=>(console.log("ppt=",n),getApiHandler(o,n))).then(doAll,n=>{console.log("e=",n)})}function v(o){console.log("ppt=",o);var n=JSON.parse(o);console.log("data=",n.Data)}})(globalThis||[eval][0]("this"));
